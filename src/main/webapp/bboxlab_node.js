!function(){"use strict";function D(){m.nodeStandaloneDebug||new db(m.baseDirectory+m.qtBinary,null,function(a,b){(m.logQt||-1!=b.toString().indexOf("javaScriptConsole"))&&z.debug(b.toString())},function(a){z.debug("exit status ",a),E||0!==a.signal&&(z.error("error quiting: "+a.error),y.debug("try restart Qt"),D())},function(a,b){(m.logQt||-1!=b.toString().indexOf("javaScriptConsole"))&&z.debug(b.toString())})}function F(){m.nodeStandaloneDebug||(E=!0,new db("killall",[m.qtBinary],function(a,b){z.debug(b.toString())},function(a){z.debug("exit status ",a.exit),0!==a.exit&&z.error("error quiting: "+a.error)},function(a,b){z.debug(b.toString())}))}function G(a){s=f.connect({path:a}),s.on("connect",function(){y.info("Connected to Qt socket.")}),s.on("data",function(a){y.debug("new data in socket ",a.toString());for(var b=a.toString(),c=b.split("$"),d=0;d<c.length;d++){var e=c[d];if(e&&0!==e.length){console.log(e);var f=e.split("|");if(f&&4==f.length&&"media"==f[0]){for(var g in cc){var h={};console.log(f),h.fullTime=f[2],h.currentTime=f[3],cc[g].send(h)}return cc=[],void 0}f&&2==f.length?Pb(f[0],f[1]):y.error("Message recieved from Qt is not valid should be : resource_id|message")}}}),s.on("end",function(){y.error("Disconnected from Qt socket."),s=null}),s.on("error",function(a){y.error("Error on Qt connection :"+a.toString()),s=null})}function L(a,b){var d=e.readFileSync(m.baseDirectory+"bootstrap.css");b.setHeader("content-type","text/css"),b.send(d.toString())}function M(a,b){var d=e.readFileSync(m.baseDirectory+"play.png");b.setHeader("content-type","image/png"),b.send(d)}function N(a,b){var d=e.readFileSync(m.baseDirectory+"jquery-1.9.1.js");b.setHeader("content-type","text/javascript"),b.send(d.toString())}function O(a,b){var d=e.readFileSync(m.baseDirectory+"notif-sender.html");d=d.toString().replace(/127.0.0.1/gi,C()),b.setHeader("content-type","text/html"),b.send(d.toString())}function P(a,b){var d=e.readFileSync(m.baseDirectory+"tuto-notif.html");d=d.toString().replace(/127.0.0.1/gi,C()),b.setHeader("content-type","text/html"),b.send(d.toString())}function Q(a,b){var d=e.readFileSync(m.baseDirectory+"websocket-chat.html");b.setHeader("content-type","text/html"),b.send(d.toString())}function R(a,b){var d=e.readFileSync(m.baseDirectory+"websocket-chat-client.html");b.setHeader("content-type","text/html"),b.send(d.toString())}function S(a,b,c){return y.info("clearing log file"),e.truncateSync(m.logFileName,0),b.send(204),c()}function T(a,b,c){var d=e.readFileSync(m.baseDirectory+"node.log").toString(),f=e.readFileSync(m.baseDirectory+"logs_inject.html").toString();return d.split("\n").forEach(function(a){var b="green";-1!=a.indexOf("[ERROR]")&&(b="red"),-1!=a.indexOf("[DEBUG]")&&(b="blue"),-1!=a.indexOf("[INFO]")&&(b="green"),a='<div class="'+b+'">'+a+"</div>",f+=a}),f+="</body></html>",d=f,b.setHeader("content-type","text/html"),b.send(d.toString()),c()}function U(a,b,c){y.info("GET /Admin/PDS "),kb(),H(a,b);var d=!1;return-1!=b.header("content-type").indexOf("xml")&&(d=!0),eb.pds&&"1"==eb.pds?(b.send(W(d)),c()):m.nodeStandaloneDebug?(b.send(W(d)),c()):(n.load_channel_list(function(a){return x=a,b.send(W(d)),c()}),void 0)}function V(a,b,c){return y.info("GET /Admin/EPG "),b.setHeader("content-type","text/xml"),b.send(W()),c()}function W(a){var b=x;if(a){if(!x||x.length<=0)return"<Plan ><channels></channels></Plan>";for(var c="<Plan ><channels>",d=b.length-1;d>=0;d--){var e=b[d];e.infos||(e.infos=""),e.number||(e.number=e.id),c=c+'<channel Logo="'+e.img+'" Nom="'+e.name+'" StreamURL="'+e.url+'" Description="'+e.infos.toString().replace(/"/g,"'").replace(/>/g,"-").replace(/\[/g,"").replace(/\]/g,"").replace(/&/g," et ")+'" PositionID="'+e.number+'"/>'}return c+="</channels></Plan>",c.toString()}for(var f=[],g=b.length-1;g>=0;g--){var e=b[g];e.infos||(e.infos=""),e.number||(e.number=e.id),f.push(e)}return f}function X(a,b,c){if(y.debug("POST /Admin/Update"),a.files.update_file.size>m.maxUploadSize)return b.send(I(400,"File is too big. Max allow =~ "+m.maxUploadSize/1e6+" Mo")),c();if(a.files.update_file.type!=m.uploadFileType)return b.send(I(400,"Allow zip file only")),c();e.renameSync(a.files.update_file.path,"/tmp/update.zip"),F();var d=l.Extract({path:m.updateExtractpath});d.on("error",function(a){throw console.log("err :",a),a}),d.on("close",function(){console.log("ok"),cb()}),e.createReadStream("/tmp/update.zip").pipe(d),b.setHeader("Location","http://"+C()+m.WebListenPort+"/index.html#SOFTWARE"),b.send(204)}function Y(a,b){y.debug("GET /Admin/Info/Status"),b.send(501)}function Z(a,b){y.debug("GET /Admin/Info/IpAddress "),b.send({ipAddress:C()})}function $(a,b,c){if(y.debug("GET /Admin/Info/Application"),kb(),H(a,b),a.params.appName){for(var d in eb.applicationsList)if(eb.applicationsList[d]&&eb.applicationsList[d].name==a.params.appName){var e={};return e.name=eb.applicationsList[d].name,e.img=eb.applicationsList[d].img,e.url=eb.applicationsList[d].url,e.infos=eb.applicationsList[d].infos,b.send(e),c()}b.send(400,I("InvalidParameter","Error on GET /Admin/Info/Application invalid appName"))}else b.send(eb.applicationsList);return c()}function _(a,b){y.debug("GET /Admin/Config"),kb(),H(a,b),b.send(eb)}function ab(a,b,c){y.debug("POST /Admin/Config"),b.setHeader("content-type","application/json");var d;return(d=ob(a.body))===!0?(y.debug("config is valid"),eb=a.body,e.writeFileSync(m.configFileName,JSON.stringify(a.body)),b.send(204),fb(),c()):(y.debug("config is not valid :"+d),b.send(400,I("InvalidParameter","Erreur dans les valeurs saisie "+d)),c())}function bb(a,b){y.debug("POST /Admin/Sender"),H(a,b),a.body||b.send(400,I("InvalidParameter","no body found"));var d=a.body.resourceId,e=a.body.message;y.debug("send notif:",d,e),Pb(d,e)}function cb(){y.debug("GET /Admin/Reboot"),new db("reboot",null,function(a,b){a.error+=b.toString(),y.error(b)},function(a){y.debug("exit status ",a.exit)})}function db(a,b,c,d,e){var f=require("child_process").spawn,g=f(a,b),h=this;h.exit=0,g.on("close",function(a){h.exit=a,h.signal=a,d&&d(h)}),g.stdout.on("data",function(a){e&&e(h,a)}),g.stderr.on("data",function(a){c&&c(h,a)})}function lb(a){return 10>a?"0"+a:a}function mb(a){return a.getUTCFullYear()+"-"+lb(a.getUTCMonth()+1)+"-"+lb(a.getUTCDate())}function nb(a){return lb(a.getHours())+":"+lb(a.getMinutes())}function pb(a,b,d){y.info("POST /UserInterface/RemoteController/Text"),H(a,b);try{var g,e=a.is("application/json"),f=a.is("text/xml");if(f&&!e?(g=c.parser(a.body,A),y.debug("request body in xml :"+a.body+" converted into:"+JSON.stringify(g))):(g=a.body,y.debug("request body in json:"+JSON.stringify(g)+g)),!g.text)return y.info("Bad request from "+a.connection.remoteAddress+" : Expected 'text' to be the root element."),b.send(400,I("MissingParameter","Expected 'text' to be the root element.")),d();y.debug("Data send to Qt: text "+g.text),m.nodeStandaloneDebug||null!==s||(y.error("nodejs is not connected to Qt please wait for reconnection..."),b.send(500,I("InternalServerError","nodejs is not yet connected to Qt"))),m.nodeStandaloneDebug||s.write(u+t+"text"+t+g.text),b.send(204)}catch(h){y.error("error on remote API :"+h);var i=I("InternalServerError",h.toString());b.send(500,i)}}function qb(a,b,d){y.info("PUT /UserInterface/RemoteController/Key"),H(a,b);try{var g,e=a.is("application/json"),f=a.is("text/xml");if(f&&!e?(g=c.parser(a.body,A),y.debug("request body in xml :"+a.body+" converted into:"+JSON.stringify(g))):(g=a.body,y.debug("request body in json:"+JSON.stringify(g)+g)),!g.key)return y.info("Bad request from "+a.connection.remoteAddress+" : Expected 'key' to be the root element."),b.send(400,I("MissingParameter","Expected 'key' to be the root element.")),d();if(!g.key.keyName)return y.info("Bad request from "+a.connection.remoteAddress+" : Expected keyName element to be a 'key' child"),b.send(400,I("MissingParameter","Expected keyName element to be a 'key' child")),d();if(!g.key.keyType)return y.info("Bad request from "+a.connection.remoteAddress+" : Expected keyType element to be a 'key' child"),b.send(400,I("MissingParameter","Expected keyType element to be a 'key' child")),d();y.debug("Data send to Qt:"+g.key.keyType+" "+g.key.keyName),m.nodeStandaloneDebug||null!==s||(y.error("nodejs is not connected to Qt please wait for reconnection..."),b.send(500,I("InternalServerError","nodejs is not yet connected to Qt"))),m.nodeStandaloneDebug||s.write(u+t+g.key.keyType+t+g.key.keyName),b.send(204)}catch(h){y.error("error on remote API :"+h);var i=I("InternalServerError",h.toString());b.send(500,i)}}function tb(a,b){this.appName=a,this.icon=b?b:"",this.appInstances=[]}function ub(a,b){this.appId=a,this.appState=b?b:{visible:!1,running:!1,focused:!1}}function vb(a,b,c){y.info("POST /Application/Run/:AppID"),H(a,b);var d=a.params.AppID,e=a.body.appState,f=sb[d];if(!d||!e)return b.send(400,I("MissingParameter","error on POST /Application/Run/:AppID : missing parameters (appID (url) or appState (body) )")),c();if(!f)return b.send(400,I("InvalidParameter","error on POST /Application/Run/:AppID : invalid appId")),c();var g="";if(e.visible===!0&&e.running===!0&&e.focused===!0)g="foreground";else if(e.visible===!1&&e.running===!0&&e.focused===!1)g="background";else{if(e.visible!==!0||e.running!==!0||e.focused!==!1)return b.send(400,I("InvalidParameter","error on POST /Application/Run/:AppID : invalid combination for appState")),c();g="foreground"}if(!m.nodeStandaloneDebug&&null===s)return y.error("nodejs is not connected to Qt please wait for reconnection..."),b.send(500,I("InternalServerError","nodejs is not yet connected to Qt")),c();for(var h=rb[f].appInstances,i=h.length-1;i>=0;i--)h[i].appId===d&&(rb[f].appInstances[i].appState=e);return m.nodeStandaloneDebug||s.write(v+t+g+t+f),b.send(204),c()}function wb(a,b,c){y.info("DELETE /Application/Run/:AppID"),H(a,b);var d=a.params.AppID,e=sb[d];return m.nodeStandaloneDebug||null!==s?e?(m.nodeStandaloneDebug||s.write(v+t+"stop"+t+e+t+d),Db(e,d),b.send(204),void 0):(y.error("Invalid AppId"),b.send(400,I("InvalidParameter","error on DELETE /Application/Run/:AppID Invalid AppId")),c()):(y.error("nodejs is not connected to Qt please wait for reconnection..."),b.send(500,I("InternalServerError","nodejs is not yet connected to Qt")),c())}function xb(a,b,c){y.info("POST /Application/:AppName"),H(a,b);var d=a.params.AppName;if(!m.nodeStandaloneDebug&&null===s)return y.error("nodejs is not connected to Qt please wait for reconnection..."),b.send(500,I("InternalServerError","nodejs is not yet connected to Qt")),c();d||b.send(400,I("MissingParameter","error POST /Application/:AppName missing AppName"));var e=Bb(d);if(!e)return b.send(400,I("InvalidParameter","error POST /Application/:AppName invalid AppName")),c();var f;return(f=e.appInstances.length>0?e.appInstances[0].appId:Cb(d))?(m.nodeStandaloneDebug||s.write(v+t+"start"+t+d+t+f),b.header("Location","http://"+w+":"+m.WebListenPort+m.basePath+"/Application/"+f),b.send(204),void 0):(b.send(400,I("InvalidParameter","error POST /Application/:AppName invalid AppName")),c())}function yb(a,b){y.error("not implemented"),b.send(501)}function zb(a,b,c){y.info("GET /Application/Run/:AppID ");var d={};if(a.params.AppID){var e=a.params.AppID;if(!e){var f=I("MissingParameter","error POST /Application/Register missing appName.");return b.send(400,f),c()}for(var g=sb[e],h=rb[g],i=h.appInstances.length-1;i>=0;i--)h.appInstances[i].appId==e&&(d.appName=h.appName,d.appID=e,d.appState=h.appInstances[i].appState);return b.send(d),c()}return b.send(500,"error"),c()}function Ab(a,b,c){if(y.info("POST /Application/Register"),H(a,b),a.body.appName){var d=a.body.appName+"_"+K();if(d)return b.header("Location","http://"+w+":"+m.WebListenPort+m.basePath+"/Application/"+d),b.send(204),c();y.error("error POST /Application/Register invalid parameters.");var e=I("InvalidParameter","error POST /Application/Register invalid appName.");return b.send(400,e),c()}y.error("error POST /Application/Register invalid parameters.");var e=I("MissingParameter","error POST /Application/Register missing appName.");return b.send(400,e),c()}function Bb(a){var b=rb[a];return void 0===b?(y.error("this app name is not valid. Should be in :"+Object.keys(rb)),null):b}function Cb(a){var b=Bb(a);if(!b)return null;y.debug("new appID request for "+JSON.stringify(b));var c=b.appName+"_"+K(),d=new ub(c);return b.appInstances.push(d),sb[c]=a,d.appState.running=!0,d.appState.visible=!0,d.appState.focused=!0,y.debug("app status :"+JSON.stringify(b)),c}function Db(a,b){var c=rb[a];if(void 0===c)return y.error("this app name is not valid. Should be in :"+Object.keys(rb)),null;for(var d in c.appInstances){var e=c.appInstances[d];if(e.appId===b)break}c.appInstances.splice(d,1),delete sb[b];var f=Jb[b];if(f){delete Jb[b],delete Ib[f],delete Mb[f],delete Lb[f];for(var g in Kb){var h=Kb[g];d=h.indexOf(f),h.splice(d,1)}}}function Eb(a,b){y.info("GET /Application?appName=..."),H(a,b);var e,d=[];if(a.params.appName)for(e in rb)rb.hasOwnProperty(e)&&rb[e].appName==a.params.appName&&(d=rb[e]);if(!a.params.appName&&!a.params.running)for(e in rb)rb.hasOwnProperty(e)&&d.push(rb[e]);b.send(d)}function Fb(a,b){this.connection=a,this.prepare=b}function Pb(a,b){var c=Kb[a];if("Media"==a)$b=JSON.parse(b);else if("Applications"==a){var d=JSON.parse(b);if(rb[d.appName]&&0===rb[d.appName].appInstances.length&&Cb(d.appName),!rb[d.appName])return;var e=rb[d.appName].appInstances[0].appState;"started"==d.state?(e.visible=!0,e.running=!0,e.focused=!0):"hid"==d.state?(e.visible=!1,e.running=!0,e.focused=!1):"showed"==d.state?(e.visible=!0,e.running=!0,e.focused=!0):"stopped"==d.state&&(rb[d.appName].appInstances=[])}if(!c||c.length<=0)return y.info("nobody listening for : "+a+" valid resources are : ",Kb),void 0;for(var f=0;f<c.length;f++){var g=c[f],h=Ib[g],i={event:JSON.parse(b),resourceID:a};if(h){y.info("channel_id "+g+"will get notification about "+a),Qb(g,i);var j={notifications:Rb(g)};h.send(j)}else Qb(g,i),y.info("channel_id "+g+" cannot be contact (via http or websocket) so the message was store in a stack")}}function Qb(a,b){Mb[a]||(Mb[a]=[]),Mb[a].push(b)}function Rb(a){var b=Mb[a];return b||(b=[]),Mb[a]=[],b}function Sb(a,b,c){y.info("DELETE /Notification/:ChannelID");var d=a.params.ChannelID,e=a.body.resources;if(y.debug("unsubscribe "+d+"  "+a.body),!Lb[d]){y.error("error POST /Notification invalid resourceID :"+h);var f=I("InvalidParameter","error POST /Notification invalid channelID ");return b.send(400,f),c()}for(var g in e){var h=e[g].resourceID;Kb[h]?(g=Kb[h].indexOf(d),g>-1&&Kb[h].splice(g,1),g=Lb[d].indexOf(h),g>-1&&Lb[d].splice(g,1),-1!=h.indexOf("Message/")&&0===Kb[h].length&&(y.debug("delete last channel_id in "+h),delete Kb[h])):y.debug("Invalid ressource_id :"+h)}H(a,b),b.send(204)}function Ub(a,b,c){y.info("POST /Notification"),H(a,b);var d;if(a.body.appID&&a.body.resources){var e=a.body.resources,f=a.body.appID;y.debug("open notification channel for appId: "+f+" resource :"+e);var g=Jb[f];g||(g=Zb(f));for(var h in Kb){var i=Kb[h].indexOf(g);-1!==i&&Kb[h].splice(i,1)}Lb[g]=[];for(var j in e){var k=e[j].resourceID;if(y.debug(f+" subscribe to a new resource:"+k+" => channelId: "+g),!Tb(k,g))return y.error("error POST /Notification invalid resourceID :"+k),d=I("InvalidParameter","error POST /Notification invalid resourceID :"+k),b.send(400,d),c()}return b.header("Location","http://"+w+":"+m.WebListenPort+m.basePath+"/Notification/"+g),b.send(204),c()}return y.error("error POST /Notification invalid parameters."+a.body),d=I("InvalidParameter","error POST /Notification invalid parameters."),b.send(400,d),c()}function Vb(a,b,c){y.info("POST /Notification/:ChannelID"),H(a,b);var d=a.params.ChannelID;if(a.body.event&&a.body.event.message&&a.body.event.appID){var e=a.body.event.appID,f=a.body.event.message;y.debug("appID:"+e+" send msg :"+f+" to channelId :"+d);var g=Ib[d];console.log(Kb.Message);var h=Kb.Message.indexOf(d);if(console.log("apr\xe8s"),-1===h){var i="Message/"+d;if(Kb[i]&&0!==Kb[i].length)return y.debug("This channel_id is a Room : "+i),Pb(i,JSON.stringify(a.body.event)),b.send(204),c();y.error("error POST /Notification/ChannelID invalid channel_id (it is not subscribe to Message)..");var j=I("InvalidParameter","error POST /Notification/ChannelID invalid channel_id (it is not subscribe to Message).");return b.send(400,j),c()}var k={};return k.resourceID="Message",k.event=a.body.event,Qb(d,k),g?g.send({notifications:Rb(d)}):y.info("channel_id cannot be contact (via http or websocket) so the message was store in a stack"),b.send(204),c()}y.error("error POST /Notification/ChannelID missing AppID or event.");var j=I("MissingParameter","error POST /Notification/ChannelID missing AppID or message.");return b.send(400,j),c()}function Wb(a,b){y.info("GET /Notification?appID=.."),H(a,b);var d=[];if(a.params.appID&&Jb[a.params.appID]&&d.push(Jb[a.params.appID]),!a.params.appID)for(var e in Jb)d.push(Jb[e]);b.send(d)}function Xb(a,b,c){y.info("PUT /Notification/:ChannelID"),H(a,b);var e,f,d=a.params.ChannelID,g=Lb[d];if(!g||!g.length){y.error("error POST /Notification invalid ChannelID :"+d);var h=I("InvalidParameter","error POST /Notification invalid ChannelID :"+d);return b.send(400,h),c()}for(var i=g.length-1;i>=0;i--)e=g[i],f=Kb[e].indexOf(d),Kb[e].splice(f,1);if(Lb[d]=[],!a.body.resources){y.error("error PUT /Notification/:ChannelID   missing 'resources' parameter");var h=I("MissingParameter","error POST /Notification  missing 'resources' parameter");return b.send(400,h),c()}var j=a.body.resources;for(var k in j)if(e=j[k].resourceID,y.debug(app_id+" subscribe to a new resource:"+e+" => channelId: "+d),!Tb(e,d)){y.error("error POST /Notification invalid resourceID :"+e);var h=I("InvalidParameter","error POST /Notification invalid resourceID :"+e);return b.send(400,h),c()}return b.send(204),c()}function Yb(a,b,c){y.info("GET /Notification/:ChannelID");var d=a.params.ChannelID;H(a,b),Ib[d]=new Fb(b,function(a){return delete Ib[d],a});var e=Rb(d);return y.debug("Data in stack :",e),e&&e.length>0?(b.send({notifications:e}),c()):void 0}function Zb(a){var b=a+"_"+K();return Jb[a]=b,b}function _b(a,b,c){return y.info("GET /Media"),H(a,b),b.send($b),c()}function ac(a,b,c){y.info("POST /Media"),H(a,b);var d;if(a.body.mediaURL&&a.body.mediaAction&&a.body.mediaStartTime&&a.body.mediaService){var e=a.body.mediaURL,f=a.body.mediaAction,g=a.body.mediaStartTime,h=a.body.mediaService;return"play"==f?(m.nodeStandaloneDebug||s.write("media"+t+f+t+e+t+g+t+h),b.send(204),c()):(y.error("error POST /Media invalid mediaAction."+a.body),d=I("InvalidParameter","error POST /Media mediaAction must be play."),b.send(400,d),c())}return y.error("error POST /Media invalid parameters."+a.body),d=I("InvalidParameter","error POST /Media invalid parameters."),b.send(400,d),c()}function bc(a,b,c){y.info("PUT /Media"),H(a,b);var d;if(a.body.mediaURL&&a.body.mediaAction&&a.body.mediaAction&&a.body.mediaService){var e=a.body.mediaURL,f=a.body.mediaAction,g=a.body.mediaService;if(a.body.mediaStartTime){var h=a.body.mediaStartTime;m.nodeStandaloneDebug||s.write("media"+t+f+t+e+t+h+t+g)}else m.nodeStandaloneDebug||s.write("media"+t+f+t+e+t+t+g);return b.send(204),c()}return y.error("error PUT /Media invalid parameters."+a.body),d=I("InvalidParameter","error PUT /Media invalid parameters."),b.send(400,d),c()}function dc(a,b,c){return y.info("GET /Media/Current"),H(a,b),m.nodeStandaloneDebug||s.write("media"+t+"current"),cc.push(b),c()}var a=require("restify"),b=require("easyxml"),c=require("xmlparser"),d=require("log4js"),e=require("fs"),f=require("net"),g=require("cron").CronJob,h=require("os"),i=require("http"),j=require("child_process").exec,k=require("websocket").server,l=require("unzip"),m=require("./node_config.js");if(!m.nodeStandaloneDebug)var n=require("./tvheadend_node.js");var o=require("./web_node.js"),p=m.namedSocket,q=m.WebListenPort;m.logFileName;var x,s=null,t="|",u="remote",v="application",w="";d.loadAppender("file"),d.addAppender(d.appenders.file(m.logFileName),"main"),d.addAppender(d.appenders.file(m.logFileName),"Qt");var y=d.getLogger("main"),z=d.getLogger("Qt");y.setLevel(m.logLevel),z.setLevel(m.logLevel);var A=m.options_xml2json;b.configure(m.easyxml);var B=a.createServer({formatters:{"text/xml":function(a,c,d){if(null!==d&&"object"==typeof d){var e=b.render(d);return e.toString()}return d.toString()},"text/html":function(a,b,c){return c.toString()},"application/json":function(a,b,d){if(console.log(d),null!==d&&"object"==typeof d)return JSON.stringify(d);var e=c.parser(d,A);return JSON.stringify(e)}}});B.pre(a.pre.userAgentConnection()),B.use(a.bodyParser({mapParams:!1})),B.use(function(a,b,c){return b.header("Access-Control-Allow-Origin","*"),b.header("Access-Control-Allow-Methods","POST, PUT, GET, DELETE","OPTIONS"),b.header("Access-Control-Allow-Headers","X-Requested-With, Authorization"),b.header("Access-Control-Expose-Headers","Location"),c()}),B.use(a.queryParser()),B.put(m.basePath+"/UserInterface/RemoteController/Key",qb),B.post(m.basePath+"/UserInterface/RemoteController/Text",pb),B.post(m.basePath+"/Applications/Register/",Ab),B.post(m.basePath+"/Applications/:AppName",xb),B.get(m.basePath+"/Applications/",Eb),B.get(m.basePath+"/Applications/:AppName",yb),B.get(m.basePath+"/Applications/Run/:AppID",zb),B.del(m.basePath+"/Applications/Run/:AppID",wb),B.post(m.basePath+"/Applications/Run/:AppID",vb),B.post(m.basePath+"/Notification/:ChannelID",Vb),B.get(m.basePath+"/Notification/:ChannelID",Yb),B.put(m.basePath+"/Notification/:ChannelID",Xb),B.post(m.basePath+"/Notification/",Ub),B.get(m.basePath+"/Notification/",Wb),B.del(m.basePath+"/Notification/:ChannelID",Sb),B.get(m.basePath+"/Media/",_b),B.post(m.basePath+"/Media/",ac),B.put(m.basePath+"/Media/",bc),B.get(m.basePath+"/Media/Current",dc),B.get(m.basePath+"/Admin/Config",_),B.post(m.basePath+"/Admin/Config",ab),B.get(m.basePath+"/Admin/Info/IpAddress",Z),B.get(m.basePath+"/Admin/Info/Application",$),B.get(m.basePath+"/Admin/Info/Status",Y),B.get(m.basePath+"/Admin/PDS",U),B.get(m.basePath+"/Media/PDS",U),B.get(m.basePath+"/Admin/EPG",V),B.post(m.basePath+"/Admin/Update",X),B.get(m.basePath+"/Admin/ClearLog",S),B.get(m.basePath+"/Admin/Logs",T),B.get(m.basePath+"/Admin/Reboot",cb),B.post(m.basePath+"/Admin/Sender",bb),B.get("/notif-tuto",P),B.get("/notif-sender",O),B.get("/websocket-chat-client",R),B.get("/websocket-chat",Q),B.get("/websocket.css",L),B.get("/jquery.js",N),B.get("/play.png",M),m.cronEnable&&!m.nodeStandaloneDebug&&new g("*/5 * * * * *",function(){null===s&&(y.info("try reconnect to Qt socket "+p),G(p))},null,!0);var eb,C=function(){var a=h.networkInterfaces();for(var b in a.eth0){var c=a.eth0[b];"IPv4"==c.family&&(w=c.address,y.info("STP ip address : "+w))}return w||(w="127.0.0.1"),w},E=!1,H=function(a,b){var c=a.accepts("application/json"),d=a.accepts("text/xml");!d||c&&d||c?(y.debug("response body will be json"),b.setHeader("content-type","application/json")):(y.debug("response body will be xml"),b.setHeader("content-type","text/xml"))},I=function(a,b){var c={code:a,message:b.toString()};return c},K=function(){return(new Date).valueOf()+""+Math.floor(1e3*Math.random()+1).toString()},fb=function(){y.info("Applying config"),kb();var a;if(m.nodeStandaloneDebug||(1==eb.dhcp?(y.info("Activate dhcp"),j("udhcpc eth0",function(a,b,c){y.debug("stdout: "+b),y.debug("stderr: "+c),null!==a&&y.debug("exec error: "+a)})):(y.info("Setting static IP ifconfig eth0 "+eb.ip+" "+eb.mask),j("ifconfig eth0 "+eb.ip+" netmask "+eb.mask,function(a,b,c){y.debug("stdout: "+b),y.debug("stderr: "+c),null!==a&&y.debug("exec error: "+a)}))),eb.applicationsList&&eb.applicationsList.length>0){rb={};for(a in eb.applicationsList){var b=eb.applicationsList[a];rb[b.name]=new tb(b.name,b.img)}}if(eb.nodeLogLevel)switch(eb.nodeLogLevel.toString()){case"1":y.debug("Log level is now : DEBUG"),y.setLevel("DEBUG");break;case"2":y.debug("Log level is now : INFO"),y.setLevel("INFO");break;case"3":y.debug("Log level is now : WARN"),y.setLevel("WARN");break;case"4":y.debug("Log level is now : ERROR"),y.setLevel("ERROR");break;case"5":y.debug("Log level is now : FATAL"),y.setLevel("FATAL")}},gb={ip:/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,mask:/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,dhcp:/^[0-1]$/,pds:/^[1-3]$/},kb=function(){if(!eb){y.debug("loading config from file");var a=e.readFileSync(m.configFileName),b=a.toString();try{eb=JSON.parse(b)}catch(c){y.fatal("Error in config.json file :",c),exit(1)}}var d=new Date;if(eb.ip=C(),eb.date=mb(d),eb.time=nb(d),eb.datetime=mb(d)+" "+nb(d),eb.pds)switch(eb.pds.toString()){case"1":y.debug("PDS manuel"),x=eb.pdsList;break;case"2":m.nodeStandaloneDebug?(y.debug("simulator so force PDS manuel"),x=eb.pdsList):(y.debug("PDS TNT"),n.pds_tvheadend&&0!==n.pds_tvheadend.length?x=n.pds_tvheadend:n.load_channel_list(function(){x=n.pds_tvheadend}))}},ob=function(a){return a?gb.ip.test(a.ip)?gb.mask.test(a.mask)?gb.dhcp.test(a.dhcp)?gb.pds.test(a.pds)?!0:"pds":"dhcp":"mask":"ip":!1},rb={},sb={};Fb.prototype={send:function(a){var b=this.prepare(a);this.connection.send(b)}};var Gb=i.createServer(function(a,b){y.error("Incoming http request on web socket server!"),b.writeHead(404),b.end()});Gb.listen(9090,function(){});var Hb=new k({httpServer:Gb,maxReceivedFrameSize:268435456,assembleFragments:!0,maxReceivedMessageSize:4294967296}),Ib={},Jb={},Kb={},Lb={},Mb={};Kb.Message=[],Kb["UserInterface/RemoteController"]=[],Kb.Applications=[],Kb.Media=[];var Nb=0,Ob=1,Tb=function(a,b){if(a&&Kb[a])Kb[a].push(b),Lb[b].push(a);else{if(!a||-1==a.indexOf("Message/"))return!1;y.debug("Creating new ressource :"+a),Kb[a]=[],Kb[a].push(b),Lb[b].push(a)}return!0};Hb.on("request",function(a){var b=a.accept("",a.origin);y.info("New web socket connection from"+a.origin);var f,c=Nb;b.on("message",function(d){if("utf8"===d.type)switch(y.debug("New message from :"+a.origin+" message :%j",d.toString().substring(0,300)),c){case Nb:var e=d.utf8Data;if(!Jb[e])return y.error("A client not register send :"+d.utf8Data),b.send("Error not register app. Reconnect and send : app_id"),b.close(),void 0;f=Jb[e],y.debug("A socket is now register  with appId :"+e),Ib[f]=new Fb(b,function(a){return JSON.stringify(a)}),c=Ob;var g=Rb(f);y.debug("Data in stack :",g),g&&g.length>0&&Ib[f].send({notification:g});break;case Ob:var i,j,k={};try{var l=JSON.parse(d.utf8Data);i=l.channelID,i=i?i:l.channelId,j=i?i:l.roomId,k.event=l.event,k.resourceID="Message",k.appID=l.AppID}catch(m){y.error("Invalid json "+m+" ",d.utf8Data),b.send(m)}if(i){var n=Kb.Message.indexOf(i);if(-1===n){y.error("Invalid : channelID = "+i+" not subscribe to Message");break}var o=Ib[i];Qb(i,k),o?o.send({notification:Rb(i)}):y.info("channel_id cannot be contact (via http or websocket) so the message was store in a stack")}else j?Pb("Message/"+j,k):(y.error("Invalid message"),b.send("Invalid message"),b.close())}}),b.on("close",function(){delete Ib[f],y.info("WebSocket close for channel id : ",f?f:"not registered client")})});var $b={},cc=[];C(),fb(),process.on("SIGINT",function(){y.info("Closing nodejs"),B.close(),Gb.close(),process.exit(0)}),process.on("SIGTERM",function(){y.info("Closing nodejs"),B.close(),Gb.close(),process.exit(0)}),m.nodeStandaloneDebug?y.info("Nodejs run in standalone mode (no connection to Qt)"):G(p),B.listen(q,function(){y.info("%s listening at %s",B.name,B.url)}),o.startWebServer(m.webServerDirectory,m.webServerPort,m.webServerPortBackup),D()}();